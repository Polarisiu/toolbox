async function sendMessage(message, title, instanceId = null) {
  const token = "";
  const chatId = "";
  const panelUrl = "https://åŸŸå"; 

  if (!token || !chatId) return false;

  const url = `https://api.telegram.org/bot${token}/sendMessage`;
  
  // æ„å»ºäº¤äº’æŒ‰é’®
  let inline_keyboard = [];
  let row1 = [{ text: "ğŸ“Š è¿›å…¥é¢æ¿", url: panelUrl }];

  // è¿™é‡Œçš„è·¯å¾„ä¿®æ­£ä¸º /instance/ï¼ŒåŒ¹é…ä½ æä¾›çš„æ ¼å¼
  if (instanceId && instanceId !== 'æœªçŸ¥') {
    row1.push({ 
      text: "ğŸŒ å®ä¾‹è¯¦æƒ…", 
      url: `${panelUrl}/instance/${instanceId}` 
    });
  }
  
  inline_keyboard.push(row1);

  const resp = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      chat_id: chatId,
      text: `<b>${title}</b>\n\n${message}`,
      parse_mode: 'HTML',
      reply_markup: { inline_keyboard: inline_keyboard }
    }),
  });
  return resp.ok;
}

async function sendEvent(event) {
  try {
    // â° æ—¶é—´è½¬æ¢å‡½æ•° (å¤„ç† CST)
    const getCSTTime = (timeStr) => {
      if (!timeStr || timeStr.startsWith('0001')) return "1-01-01 08:00:00";
      const date = new Date(timeStr.replace(/\.\d+Z$/, 'Z'));
      const cst = new Date(date.getTime() + 8 * 60 * 60 * 1000);
      const f = (n) => n.toString().padStart(2, '0');
      return `${cst.getUTCFullYear()}-${f(cst.getUTCMonth() + 1)}-${f(cst.getUTCDate())} ${f(cst.getUTCHours())}:${f(cst.getUTCMinutes())}:${f(cst.getUTCSeconds())}`;
    };

    // ğŸ“¦ æµé‡å•ä½è½¬æ¢å‡½æ•°
    const formatTraffic = (bytes) => {
      if (!bytes || bytes === 0) return 'æ— é™åˆ¶';
      const gb = bytes / (1024 ** 3);
      if (gb >= 1024) return `${(gb / 1024).toFixed(2)} TB`;
      return `${gb.toFixed(2)} GB`;
    };

    // å†…å­˜å’Œç£ç›˜æ ¼å¼åŒ–å‡½æ•°
    const formatMemory = (bytes) => {
      if (!bytes || bytes === 0) return '0';
      const gb = bytes / (1024 ** 3);
      return gb < 1 ? `${Math.round(gb * 1024)}MB` : `${Math.round(gb)}G`;
    };

    const formatSwapMemory = (bytes) => {
      if (!bytes || bytes === 0) return '0';
      const gb = bytes / (1024 ** 3);
      return gb < 1 ? `${Math.round(gb * 1024)}MB` : `${Math.round(gb)}G`;
    };

    // IP åœ°å€éƒ¨åˆ†éšè—å‡½æ•°
    const hideIP = (ip) => {
      if (!ip) return 'æœªçŸ¥';
      const parts = ip.split('.');
      if (parts.length === 4) {
        return `${parts[0]}.${parts[1]}.xxx.xxx`;
      }
      // å¯¹äº IPv6 åœ°å€ï¼Œåªæ˜¾ç¤ºå‰åŠéƒ¨åˆ†
      const v6Parts = ip.split(':');
      return v6Parts.slice(0, 3).join(':') + ':xxxx:xxxx:xxxx';
    };

    // æ ‡é¢˜æ˜ å°„
    const eventTitles = {
      'Online':  'ğŸŸ¢ æœåŠ¡å™¨ä¸Šçº¿',
      'Offline': 'ğŸ”´ æœåŠ¡å™¨ç¦»çº¿',
      'Alert':   'âš ï¸ å¼‚å¸¸è­¦æŠ¥',
      'Renew':   'ğŸ’° ç»­è´¹é€šçŸ¥',
      'Expire':  'ğŸš¨ åˆ°æœŸé¢„è­¦',
      'Test':    'ğŸ§ª æµ‹è¯•é€šçŸ¥'
    };

    const title = eventTitles[event.event] || 'ğŸ“Œ ç³»ç»Ÿé€šçŸ¥';
    
    let clientInfo = '';
    let targetInstanceId = null;

    if (event.clients && event.clients.length > 0) {
      const c = event.clients[0];
      targetInstanceId = c.uuid;
      
      const region = c.region ? ` [${c.region}]` : '';
      const hiddenIPv4 = hideIP(c.ipv4);
      const hiddenIPv6 = hideIP(c.ipv6);
      
      const mem = c.mem_total ? formatMemory(c.mem_total) : '0';
      const swap = c.swap_total ? formatSwapMemory(c.swap_total) : '0';
      const disk = c.disk_total ? formatMemory(c.disk_total) : '0';
      
      clientInfo += `ğŸ–¥ï¸æœåŠ¡å™¨ï¼š${c.name}${region}\n`;
      clientInfo += `ğŸ“é…ç½®ï¼š${c.cpu_cores || '0'}C / ${mem}${swap !== '0' ? `+${swap}` : ''} / ${disk}\n`;
      clientInfo += `ğŸŒIPv4ï¼š${hiddenIPv4}\n`;
      clientInfo += `ğŸŒIPv6ï¼š${hiddenIPv6}\n`;

      // æµé‡ç®¡å®¶
      const trafficLimit = formatTraffic(c.traffic_limit);
      clientInfo += `ğŸ“¶æµé‡é™é¢ï¼š${trafficLimit}${c.traffic_limit_type ? ` (${c.traffic_limit_type})` : ''}\n`;
      
      if (event.event === 'Renew' || event.event === 'Expire') {
         clientInfo += `ğŸ’°è´¦å•ï¼š${c.currency || '$'}${c.price || '0'} (${c.billing_cycle || '0'}å¤©/ä»˜)\n`;
      }
    } else {
      clientInfo += `ğŸ–¥ï¸æœåŠ¡å™¨ï¼šæœªçŸ¥è®¾å¤‡\nğŸ“é…ç½®ï¼šæœªçŸ¥\nğŸŒIPv4ï¼šæœªçŸ¥\nğŸŒIPv6ï¼šæœªçŸ¥\nğŸ“¶æµé‡é™é¢ï¼šæœªçŸ¥\n`;
    }

    let message = clientInfo;
    message += `\nğŸ—’ï¸çŠ¶æ€ï¼š${event.event} (${eventTitles[event.event] || 'æœªçŸ¥'})\n`;
    message += `âŒšï¸æ—¶é—´ï¼š${getCSTTime(event.time)} (CST)`;

    if (event.message && event.message.trim()) {
      message += `\n\nğŸ“„è¯¦ç»†æè¿°ï¼š\n<i>${event.message}</i>`;
    }

    // å‘é€é€šçŸ¥ï¼Œä¼ å…¥çœŸæ­£çš„ UUID ä»¥ç”Ÿæˆæ­£ç¡®çš„æŒ‰é’®é“¾æ¥
    return await sendMessage(message, title, targetInstanceId);
  } catch (error) {
    return await sendMessage(`è„šæœ¬è§£æå‡ºé”™: ${error.message}`, 'âŒ Error');
  }
}

